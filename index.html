<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Release Calendar v11 (Fixed)</title>

    <!-- 1. EXTERNAL LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        game: '#8b5cf6', movie: '#f43f5e', sport: '#10b981', tv: '#f59e0b',
                        dark: '#020617', 
                        glass: 'rgba(15, 23, 42, 0.75)',
                        glassBorder: 'rgba(255, 255, 255, 0.08)'
                    },
                    animation: { 
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-glow': 'pulseGlow 3s infinite'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseGlow: { '0%, 100%': { opacity: '1', boxShadow: '0 0 10px rgba(59, 130, 246, 0.2)' }, '50%': { opacity: '0.7', boxShadow: '0 0 20px rgba(59, 130, 246, 0.5)' } }
                    }
                }
            }
        }
    </script>
    <!-- FullCalendar v6 -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root { --app-bg: #020617; --fc-border-color: rgba(255,255,255,0.05); }
        
        body { 
            background-color: var(--app-bg); 
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.08), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.08), transparent 25%);
            color: #e2e8f0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; 
        }
        
        /* GLASS UI */
        .glass-panel {
            background: var(--glass); 
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glassBorder); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        .glass-button {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }
        .glass-button:hover { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.1); }

        /* CALENDAR */
        .fc { --fc-page-bg-color: transparent; --fc-neutral-bg-color: rgba(255,255,255,0.02); }
        .fc-theme-standard td, .fc-theme-standard th { border-color: var(--fc-border-color) !important; }
        .fc-col-header-cell-cushion { color: #94a3b8; font-weight: 800; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; padding: 12px 0 !important; }
        .fc-daygrid-day-number { color: #64748b; font-weight: 600; font-size: 0.8rem; padding: 6px; }
        .fc-multimonth-title { font-size: 0.85rem; font-weight: 800; letter-spacing: 1px; color: #fff; margin-bottom: 10px; }
        .fc-multimonth-daygrid-table { background: rgba(0,0,0,0.2) !important; border-radius: 8px; overflow: hidden; }

        /* EVENTS */
        .fc-event {
            border: none !important; border-radius: 4px; margin: 2px !important;
            transition: all 0.2s; overflow: hidden; cursor: pointer; position: relative;
            background-color: var(--fc-event-bg-color); min-height: 26px;
        }
        .event-poster-bg { position: absolute; inset: 0; background-size: cover; background-position: center; opacity: 0.75; z-index: 0; }
        .event-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(2, 6, 23, 0.95), rgba(2, 6, 23, 0.2)); z-index: 1; }
        .event-content { position: relative; z-index: 2; padding: 3px 5px; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; }
        .fc-event:hover { z-index: 50; transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hype-event { box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.6); }

        /* UTILS */
        .fc-event.dimmed { opacity: 0.1; filter: grayscale(1); pointer-events: none; }
        .selection-mode .fc-event { filter: grayscale(1) opacity(0.3); pointer-events: none; }
        .selection-mode .fc-event.selected-event { filter: grayscale(0) opacity(1); box-shadow: 0 0 0 2px #fff; transform: scale(0.95); pointer-events: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .progress-bar-fill { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm selection:bg-blue-500/30">

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- NAVBAR -->
    <nav class="h-14 border-b border-gray-800 flex items-center justify-between px-4 md:px-6 bg-[#020617]/90 backdrop-blur-md z-50 relative">
        <div class="flex items-center gap-4">
            <button onclick="window.toggleMobileSidebar()" class="md:hidden text-gray-400 hover:text-white p-1"><i class="fa-solid fa-bars text-lg"></i></button>
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-blue-600 to-indigo-500 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="fa-solid fa-calendar-days text-white text-sm"></i>
                </div>
                <div>
                    <h1 class="text-base font-black tracking-tight text-white leading-none">RELEASE<span class="text-blue-500">CAL</span></h1>
                    <span id="modeBadge" class="text-[9px] font-mono text-gray-500 uppercase tracking-widest">v11 Fixed</span>
                </div>
            </div>
        </div>
        <div id="authButtons" class="flex gap-2"></div>
    </nav>

    <!-- LAYOUT -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <div id="sidebarOverlay" onclick="window.toggleMobileSidebar()" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>
        
        <aside id="mainSidebar" class="fixed md:relative inset-y-0 left-0 w-80 bg-[#020617] md:bg-transparent border-r border-gray-800 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col h-full shadow-2xl md:shadow-none backdrop-blur-xl">
            <!-- Countdown Widget -->
            <div class="p-5 pb-0">
                <div id="countdownWidget" class="hidden animate-slide-up">
                    <div class="relative overflow-hidden rounded-xl bg-gradient-to-br from-slate-900 to-slate-800 border border-white/10 p-4 group cursor-pointer hover:border-blue-500/30 transition shadow-lg" onclick="window.zoomToNextEvent()">
                        <div class="flex items-center justify-between mb-3 relative z-10">
                            <span class="text-[9px] font-bold text-blue-400 uppercase tracking-widest border border-blue-500/20 px-1.5 py-0.5 rounded bg-blue-500/5">NEXT DROP</span>
                            <i class="fa-solid fa-clock text-gray-600 text-xs"></i>
                        </div>
                        <h3 id="nextEventTitle" class="text-sm font-bold text-white truncate mb-4 relative z-10 pl-1 border-l-2 border-blue-500">Loading...</h3>
                        <div class="flex justify-between gap-1 relative z-10">
                            <div class="text-center flex-1 bg-black/20 rounded py-1"><span class="text-lg font-black text-white block leading-none" id="cd-d">0</span><span class="text-[9px] text-gray-500 font-bold">DAYS</span></div>
                            <div class="text-center flex-1 bg-black/20 rounded py-1"><span class="text-lg font-black text-white block leading-none" id="cd-h">0</span><span class="text-[9px] text-gray-500 font-bold">HRS</span></div>
                            <div class="text-center flex-1 bg-black/20 rounded py-1"><span class="text-lg font-black text-white block leading-none" id="cd-m">0</span><span class="text-[9px] text-gray-500 font-bold">MIN</span></div>
                        </div>
                        <div id="nextEventDate" class="text-center text-[10px] text-gray-500 mt-2 font-mono relative z-10"></div>
                    </div>
                </div>
            </div>

            <!-- Stats & Filters -->
            <div class="p-5 flex flex-col gap-6 overflow-y-auto flex-1 custom-scrollbar">
                <div>
                    <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 flex justify-between">Library Stats</h3>
                    <div class="space-y-3">
                        <div onclick="window.filterCat('game')" class="group cursor-pointer">
                            <div class="flex justify-between text-xs mb-1"><span class="text-gray-400 group-hover:text-white transition flex items-center gap-2"><i class="fa-solid fa-gamepad text-game"></i> Games</span> <span id="count-game" class="font-mono text-gray-500">0</span></div>
                            <div class="h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div id="bar-game" class="h-full bg-game w-0 progress-bar-fill"></div></div>
                        </div>
                        <div onclick="window.filterCat('movie')" class="group cursor-pointer">
                            <div class="flex justify-between text-xs mb-1"><span class="text-gray-400 group-hover:text-white transition flex items-center gap-2"><i class="fa-solid fa-film text-movie"></i> Movies</span> <span id="count-movie" class="font-mono text-gray-500">0</span></div>
                            <div class="h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div id="bar-movie" class="h-full bg-movie w-0 progress-bar-fill"></div></div>
                        </div>
                        <div onclick="window.filterCat('tv')" class="group cursor-pointer">
                            <div class="flex justify-between text-xs mb-1"><span class="text-gray-400 group-hover:text-white transition flex items-center gap-2"><i class="fa-solid fa-tv text-tv"></i> Shows</span> <span id="count-tv" class="font-mono text-gray-500">0</span></div>
                            <div class="h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div id="bar-tv" class="h-full bg-tv w-0 progress-bar-fill"></div></div>
                        </div>
                        <div onclick="window.filterCat('sport')" class="group cursor-pointer">
                            <div class="flex justify-between text-xs mb-1"><span class="text-gray-400 group-hover:text-white transition flex items-center gap-2"><i class="fa-solid fa-trophy text-sport"></i> Sports</span> <span id="count-sport" class="font-mono text-gray-500">0</span></div>
                            <div class="h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div id="bar-sport" class="h-full bg-sport w-0 progress-bar-fill"></div></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button onclick="window.filterCat('all')" class="glass-button py-2 rounded text-[10px] font-bold text-gray-400 uppercase tracking-wide hover:text-white">All Events</button>
                        <button onclick="window.toggleHypeOnly()" id="hypeFilterBtn" class="glass-button py-2 rounded text-[10px] font-bold text-orange-500 uppercase tracking-wide flex items-center justify-center gap-1 hover:text-orange-400"><i class="fa-solid fa-fire"></i> Hype</button>
                    </div>
                </div>

                <div class="pt-4 mt-auto border-t border-gray-800">
                    <button id="toggleSelectionBtn" onclick="window.toggleSelectionMode()" class="w-full py-2.5 border border-slate-700/50 rounded-lg text-xs font-bold text-gray-400 hover:text-white hover:bg-slate-800/50 transition mb-2">MANAGE EVENTS</button>
                    <button onclick="window.exportData()" class="w-full py-2.5 border border-slate-700/50 rounded-lg text-xs font-bold text-gray-400 hover:text-white hover:bg-slate-800/50 transition flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> EXPORT JSON</button>
                </div>
            </div>

            <div class="p-4 bg-slate-900/80 border-t border-gray-800 backdrop-blur">
                <button onclick="window.openEventModal()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-blue-600/20 active:scale-95 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> NEW RELEASE</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-900/20">
            <!-- Control Bar -->
            <div class="px-4 py-3 md:px-6 flex flex-col md:flex-row gap-3 items-center justify-between z-30">
                <div class="relative w-full md:w-80 group">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs group-focus-within:text-blue-500 transition"></i>
                    <i id="clearSearchBtn" class="fa-solid fa-xmark absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs cursor-pointer hover:text-white hidden" onclick="window.clearSearch()"></i>
                    <input type="text" id="globalSearch" placeholder="Search title, category..." class="w-full pl-9 pr-8 py-2 border border-slate-700/50 rounded-full bg-slate-900/60 backdrop-blur text-gray-200 text-xs focus:border-blue-500/50 outline-none transition shadow-lg">
                </div>
                
                <div class="flex bg-slate-900/60 backdrop-blur border border-slate-700/50 rounded-full p-1 shadow-lg">
                    <button onclick="window.changeView('multiMonthYear')" class="px-4 py-1.5 rounded-full text-[10px] font-bold text-gray-400 hover:text-white hover:bg-white/5 transition" id="btnYear">YEAR</button>
                    <button onclick="window.changeView('dayGridMonth')" class="px-4 py-1.5 rounded-full text-[10px] font-bold text-gray-400 hover:text-white hover:bg-white/5 transition" id="btnMonth">MONTH</button>
                    <button onclick="window.changeView('listMonth')" class="px-4 py-1.5 rounded-full text-[10px] font-bold text-gray-400 hover:text-white hover:bg-white/5 transition" id="btnList">LIST</button>
                </div>
            </div>

            <!-- Calendar -->
            <div class="flex-1 overflow-y-auto px-2 pb-2 md:px-6 md:pb-6 custom-scrollbar">
                <div id="calendar" class="h-full w-full glass-panel rounded-2xl p-1 md:p-4"></div>
            </div>
            
            <!-- Bulk Delete -->
            <button id="bulkDeleteFab" onclick="window.deleteSelectedEvents()" class="fixed bottom-6 right-6 md:bottom-8 md:right-8 bg-red-600 text-white px-6 py-3.5 rounded-full shadow-2xl font-bold flex items-center gap-3 z-50 transform translate-y-32 transition-transform duration-300 hover:bg-red-500 border border-red-400">
                <i class="fa-solid fa-trash"></i> <span class="text-xs">DELETE <span id="bulkDeleteCount">0</span></span>
            </button>
        </main>
    </div>

    <!-- MODAL: ADD/EDIT EVENT -->
    <div id="eventModal" class="fixed inset-0 z-[60] hidden bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-lg p-6 rounded-t-2xl md:rounded-2xl relative transform transition-transform duration-300 translate-y-full md:translate-y-0 opacity-0 md:opacity-100 flex flex-col max-h-[90vh] overflow-y-auto border border-gray-700/50 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-lg font-black text-white tracking-wide">NEW RELEASE</h2>
                <button onclick="window.closeModal('eventModal')" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form id="addEventForm" class="space-y-4">
                <input type="hidden" id="evId"> 
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider mb-1 block">Title</label>
                    <input type="text" id="evTitle" required class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none text-xs">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider mb-1 block">Date</label>
                        <input type="date" id="evDate" required class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none text-xs">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider mb-1 block">Category</label>
                        <select id="evCategory" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none text-xs appearance-none">
                            <option value="game">Video Game</option>
                            <option value="movie">Movie</option>
                            <option value="tv">TV Show</option>
                            <option value="sport">Sport</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider mb-1 block">Platform / Network</label>
                    <input type="text" id="evSub" placeholder="e.g. Steam, Netflix" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none text-xs">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider mb-1 block">Image URL</label>
                        <input type="url" id="evImage" placeholder="https://..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none text-xs">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider mb-1 block">Link URL</label>
                        <input type="url" id="evLink" placeholder="Official Link..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none text-xs">
                    </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg border border-white/5 cursor-pointer hover:bg-white/10 transition" onclick="document.getElementById('evHype').click()">
                    <input type="checkbox" id="evHype" class="w-4 h-4 rounded bg-slate-700 accent-blue-600">
                    <div class="flex flex-col">
                        <span class="text-xs font-bold text-white">High Priority (Hype)</span>
                        <span class="text-[9px] text-gray-400">Adds special glow to event card</span>
                    </div>
                    <i class="fa-solid fa-fire text-orange-500 ml-auto animate-pulse"></i>
                </div>
                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3.5 rounded-lg font-bold text-sm mt-2 shadow-lg shadow-blue-600/20">SAVE EVENT</button>
            </form>
        </div>
    </div>

    <!-- MODAL: DETAILS -->
    <div id="detailsModal" class="fixed inset-0 z-[60] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-md rounded-2xl relative transform transition-all scale-95 opacity-0 overflow-hidden border border-gray-700 shadow-2xl">
            <div id="detImageContainer" class="h-64 w-full bg-slate-800 bg-cover bg-center hidden relative">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-transparent"></div>
                <button onclick="window.closeModal('detailsModal')" class="absolute top-4 right-4 bg-black/50 hover:bg-black text-white rounded-full w-8 h-8 flex items-center justify-center backdrop-blur"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <button id="detCloseNoImg" onclick="window.closeModal('detailsModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white hidden"><i class="fa-solid fa-xmark text-xl"></i></button>

            <div class="p-6 pt-2 text-center relative">
                <div id="detColor" class="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl shadow-xl border-2 border-white/10 -mt-8 relative z-10 bg-slate-900 transition-transform hover:scale-110"></div>
                <h2 id="detTitle" class="text-2xl font-black text-white mb-1 leading-tight mt-2 drop-shadow-lg"></h2>
                
                <div class="flex items-center justify-center gap-2 mb-6">
                    <span id="detBadge" class="hidden text-[9px] bg-orange-500/10 text-orange-400 border border-orange-500/50 px-2 py-0.5 rounded uppercase font-bold tracking-wider">HYPE</span>
                    <span id="detSub" class="text-[10px] text-blue-400 uppercase tracking-widest font-bold"></span>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 mb-6 border border-slate-700/50 flex items-center justify-center gap-3">
                    <i class="fa-regular fa-calendar-check text-gray-400"></i>
                    <span id="detDate" class="text-sm font-mono text-white font-bold"></span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <a id="detLinkBtn" href="#" target="_blank" class="col-span-2 hidden bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 hover:text-white py-2.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 border border-blue-500/20">VISIT LINK</a>
                    <button id="editEventBtn" class="bg-slate-800 hover:bg-slate-700 text-white py-2.5 rounded-lg text-xs font-bold transition border border-gray-700">EDIT</button>
                    <button id="downloadIcsBtn" class="bg-slate-800 hover:bg-slate-700 text-gray-300 py-2.5 rounded-lg text-xs font-bold transition border border-gray-700">SYNC</button>
                    <button id="deleteEventBtn" class="col-span-2 bg-red-500/10 hover:bg-red-500/90 text-red-500 hover:text-white py-2.5 rounded-lg text-xs font-bold transition border border-red-500/20">DELETE EVENT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: LOGIN -->
    <div id="loginModal" class="fixed inset-0 z-[70] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm p-8 rounded-2xl relative">
            <button onclick="window.closeModal('loginModal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-xl font-black mb-6 text-center text-white">LOGIN</h2>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email Address" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none text-xs">
                <input type="password" id="loginPass" placeholder="Password" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none text-xs">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold text-sm">Log In</button>
            </form>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "PASTE_API_KEY_HERE", 
            authDomain: "PASTE_PROJECT_ID.firebaseapp.com",
            projectId: "PASTE_PROJECT_ID",
        };

        let db, auth, isLocalMode = false;
        let allEvents = [];
        let calendar;
        let selectionMode = false;
        let selectedEventIds = new Set();
        let countdownInterval;
        let hypeOnly = false;
        const isMobile = window.innerWidth < 768;

        if (firebaseConfig.apiKey === "PASTE_API_KEY_HERE" || !firebaseConfig.apiKey) {
            isLocalMode = true;
        } else {
            try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { isLocalMode = true; }
        }
        document.getElementById('modeBadge').innerText = isLocalMode ? "LOCAL" : "CLOUD";

        const DataService = {
            init: (callback) => {
                if(isLocalMode) {
                    const localData = JSON.parse(localStorage.getItem('localEvents')) || [];
                    callback(localData);
                    updateAuthUI({ email: 'guest@local' });
                } else {
                    const q = query(collection(db, "events"));
                    onSnapshot(q, (snapshot) => {
                        const events = [];
                        snapshot.forEach(doc => events.push({ id: doc.id, ...doc.data() }));
                        callback(events);
                    });
                }
            },
            save: async (event) => {
                try {
                    if (event.id) {
                        if(isLocalMode) {
                            const current = JSON.parse(localStorage.getItem('localEvents')) || [];
                            const idx = current.findIndex(e => String(e.id) === String(event.id));
                            if(idx > -1) { current[idx] = event; localStorage.setItem('localEvents', JSON.stringify(current)); location.reload(); }
                        } else {
                            const { id, ...data } = event;
                            await updateDoc(doc(db, "events", String(id)), data);
                        }
                        showToast("Event Updated", "success");
                    } else {
                        if(isLocalMode) {
                            const current = JSON.parse(localStorage.getItem('localEvents')) || [];
                            event.id = 'loc_' + Date.now().toString(); 
                            current.push(event); localStorage.setItem('localEvents', JSON.stringify(current)); location.reload(); 
                        } else {
                            await addDoc(collection(db, "events"), event);
                        }
                        showToast("Event Created", "success");
                    }
                } catch(e) { console.error(e); showToast("Save failed", "error"); }
            },
            delete: async (id) => {
                try {
                    if(isLocalMode) {
                        let current = JSON.parse(localStorage.getItem('localEvents')) || [];
                        const filtered = current.filter(e => String(e.id) !== String(id));
                        localStorage.setItem('localEvents', JSON.stringify(filtered)); location.reload();
                    } else {
                        await deleteDoc(doc(db, "events", String(id)));
                    }
                    showToast("Event Deleted", "info");
                } catch(e) { console.error(e); showToast("Delete failed", "error"); }
            },
            deleteMultiple: async (ids) => {
                try {
                    if(isLocalMode) {
                        let current = JSON.parse(localStorage.getItem('localEvents')) || [];
                        const filtered = current.filter(e => !ids.has(String(e.id)));
                        localStorage.setItem('localEvents', JSON.stringify(filtered)); location.reload();
                    } else {
                        const batch = writeBatch(db);
                        ids.forEach(id => batch.delete(doc(db, "events", id)));
                        await batch.commit();
                    }
                    showToast(`Deleted ${ids.size} events`, "info");
                } catch(e) { console.error(e); showToast("Bulk delete failed", "error"); }
            },
            updateDate: async (id, newDateStr) => {
                if(isLocalMode) {
                    const current = JSON.parse(localStorage.getItem('localEvents')) || [];
                    const idx = current.findIndex(e => String(e.id) === String(id));
                    if(idx > -1) { current[idx].date = newDateStr; localStorage.setItem('localEvents', JSON.stringify(current)); }
                } else {
                    await updateDoc(doc(db, "events", id), { date: newDateStr });
                }
                showToast("Date Moved", "success");
            }
        };

        // --- CALENDAR SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: isMobile ? 'listYear' : 'multiMonthYear',
                multiMonthMaxColumns: 3,
                headerToolbar: false, 
                height: '100%',
                themeSystem: 'standard',
                editable: true,
                droppable: true,
                events: [],
                eventClick: handleEventClick,
                eventDrop: (info) => DataService.updateDate(info.event.id, info.event.start.toISOString().split('T')[0]),
                
                eventContent: function(arg) {
                    const props = arg.event.extendedProps;
                    if (arg.view.type !== 'listYear' && arg.view.type !== 'listMonth') {
                        let bgStyle = props.img ? `background-image:url('${props.img}')` : '';
                        let posterDiv = props.img ? `<div class="event-poster-bg" style="${bgStyle}"></div>` : `<div class="event-poster-bg" style="background:linear-gradient(45deg, ${arg.event.backgroundColor}, #1e293b)"></div>`;
                        
                        return { html: `
                            ${posterDiv}
                            <div class="event-overlay"></div>
                            <div class="event-content">
                                <div class="font-bold text-white text-[9px] leading-tight drop-shadow-md truncate">${arg.event.title}</div>
                                ${props.isHype ? '<i class="fa-solid fa-fire text-orange-400 text-[8px] mt-1 animate-pulse"></i>' : ''}
                            </div>` 
                        };
                    }
                },
                eventClassNames: (arg) => arg.event.extendedProps.isHype ? ['hype-event'] : []
            });
            calendar.render();
            updateActiveViewBtn(isMobile ? 'listYear' : 'multiMonthYear');

            DataService.init((events) => {
                allEvents = events;
                renderEvents(events);
                updateStats(events);
                startCountdown(events);
            });
        });

        function renderEvents(events) {
            calendar.removeAllEvents();
            let toRender = hypeOnly ? events.filter(e => e.isHype) : events;
            const searchVal = document.getElementById('globalSearch').value.toLowerCase();
            
            toRender.forEach(data => {
                let color = '#3b82f6';
                if(data.category === 'game') color = '#8b5cf6';
                if(data.category === 'movie') color = '#f43f5e';
                if(data.category === 'sport') color = '#10b981';
                if(data.category === 'tv') color = '#f59e0b';
                
                let classList = [];
                if(data.isHype) classList.push('hype-event');
                if(searchVal) {
                    const match = data.title.toLowerCase().includes(searchVal) || 
                                  (data.subCategory && data.subCategory.toLowerCase().includes(searchVal)) ||
                                  data.category.includes(searchVal);
                    if(!match) classList.push('dimmed');
                }

                calendar.addEvent({
                    id: String(data.id),
                    title: data.title,
                    start: data.date,
                    backgroundColor: color,
                    borderColor: color,
                    className: classList,
                    extendedProps: { 
                        category: data.category, sub: data.subCategory, 
                        isHype: data.isHype, img: data.img || null, link: data.link || null 
                    }
                });
            });
        }

        // --- GLOBAL FUNCTIONS EXPORT ---
        window.changeView = (viewName) => { calendar.changeView(viewName); updateActiveViewBtn(viewName); }
        function updateActiveViewBtn(viewName) {
            ['btnYear','btnMonth','btnList'].forEach(id => document.getElementById(id).classList.remove('bg-white/10', 'text-white'));
            if(viewName.includes('Year')) document.getElementById('btnYear').classList.add('bg-white/10', 'text-white');
            else if(viewName.includes('Month') && !viewName.includes('List')) document.getElementById('btnMonth').classList.add('bg-white/10', 'text-white');
            else document.getElementById('btnList').classList.add('bg-white/10', 'text-white');
        }

        document.getElementById('globalSearch').addEventListener('input', () => renderEvents(allEvents));
        window.clearSearch = () => { document.getElementById('globalSearch').value = ''; renderEvents(allEvents); document.getElementById('clearSearchBtn').classList.add('hidden'); }
        document.getElementById('globalSearch').addEventListener('input', (e) => {
            document.getElementById('clearSearchBtn').style.display = e.target.value ? 'block' : 'none';
        });

        function handleEventClick(info) {
            info.jsEvent.preventDefault();
            if(selectionMode) {
                const id = String(info.event.id);
                if(selectedEventIds.has(id)) { selectedEventIds.delete(id); info.el.classList.remove('selected-event'); } 
                else { selectedEventIds.add(id); info.el.classList.add('selected-event'); }
                updateBulkDeleteUI();
            } else { showEventDetails(info.event); }
        }

        window.openEventModal = (eventObj = null) => {
            const form = document.getElementById('addEventForm');
            if (eventObj) {
                const props = eventObj.extendedProps;
                document.getElementById('evId').value = eventObj.id;
                document.getElementById('evTitle').value = eventObj.title;
                document.getElementById('evDate').value = eventObj.startStr;
                document.getElementById('evCategory').value = props.category;
                document.getElementById('evSub').value = props.sub || '';
                document.getElementById('evImage').value = props.img || '';
                document.getElementById('evLink').value = props.link || '';
                document.getElementById('evHype').checked = props.isHype;
                document.getElementById('modalTitle').innerText = "EDIT RELEASE";
                document.getElementById('submitBtn').innerText = "UPDATE EVENT";
            } else {
                form.reset();
                document.getElementById('evId').value = '';
                document.getElementById('modalTitle').innerText = "NEW RELEASE";
                document.getElementById('submitBtn').innerText = "ADD TO CALENDAR";
            }
            window.openModal('eventModal');
        };

        function showEventDetails(event) {
            const props = event.extendedProps;
            document.getElementById('detTitle').innerText = event.title;
            document.getElementById('detSub').innerText = props.sub || props.category;
            document.getElementById('detDate').innerText = event.start.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('detBadge').style.display = props.isHype ? 'inline-block' : 'none';

            if (props.img) {
                document.getElementById('detImageContainer').style.backgroundImage = `url('${props.img}')`;
                document.getElementById('detImageContainer').classList.remove('hidden');
                document.getElementById('detColor').classList.add('hidden');
                document.getElementById('detCloseNoImg').classList.add('hidden');
            } else {
                document.getElementById('detImageContainer').classList.add('hidden');
                document.getElementById('detColor').classList.remove('hidden');
                document.getElementById('detCloseNoImg').classList.remove('hidden');
                document.getElementById('detColor').style.backgroundColor = event.backgroundColor;
                let icon = 'fa-star';
                if(props.category === 'game') icon = 'fa-gamepad';
                if(props.category === 'movie') icon = 'fa-film';
                if(props.category === 'tv') icon = 'fa-tv';
                if(props.category === 'sport') icon = 'fa-trophy';
                document.getElementById('detColor').innerHTML = `<i class="fa-solid ${icon} text-white"></i>`;
            }

            document.getElementById('detLinkBtn').href = props.link || '#';
            document.getElementById('detLinkBtn').classList.toggle('hidden', !props.link);
            document.getElementById('editEventBtn').onclick = () => { window.closeModal('detailsModal'); window.openEventModal(event); };
            
            const delBtn = document.getElementById('deleteEventBtn');
            const newDelBtn = delBtn.cloneNode(true);
            delBtn.parentNode.replaceChild(newDelBtn, delBtn);
            newDelBtn.addEventListener('click', () => {
                if(confirm("Delete this event?")) { DataService.delete(event.id); window.closeModal('detailsModal'); }
            });
            window.openModal('detailsModal');
        }

        document.getElementById('addEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                id: document.getElementById('evId').value || null,
                title: document.getElementById('evTitle').value,
                date: document.getElementById('evDate').value,
                category: document.getElementById('evCategory').value,
                subCategory: document.getElementById('evSub').value,
                isHype: document.getElementById('evHype').checked,
                img: document.getElementById('evImage').value,
                link: document.getElementById('evLink').value
            };
            await DataService.save(data);
            window.closeModal('eventModal');
            if(data.isHype) confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        });

        // --- STATS, UTILS & AUTH (Exported to Window) ---
        window.filterCat = (cat) => { 
            cat === 'all' ? renderEvents(allEvents) : renderEvents(allEvents.filter(e => e.category === cat));
            if(isMobile) window.toggleMobileSidebar();
        }
        window.toggleHypeOnly = () => {
            hypeOnly = !hypeOnly;
            const btn = document.getElementById('hypeFilterBtn');
            if(hypeOnly) btn.classList.add('bg-orange-500/20', 'border-orange-500', 'text-orange-400');
            else btn.classList.remove('bg-orange-500/20', 'border-orange-500', 'text-orange-400');
            renderEvents(allEvents);
        }
        window.toggleMobileSidebar = () => {
            document.getElementById('mainSidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.toggle('hidden');
        }
        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); void document.getElementById(id).offsetWidth; document.getElementById(id).querySelector('.glass-panel').classList.remove('translate-y-full','opacity-0'); }
        window.closeModal = (id) => { document.getElementById(id).querySelector('.glass-panel').classList.add('translate-y-full','opacity-0'); setTimeout(()=>document.getElementById(id).classList.add('hidden'),300); }
        window.toggleSelectionMode = () => {
            selectionMode = !selectionMode;
            const btn = document.getElementById('toggleSelectionBtn');
            const calDiv = document.getElementById('calendar');
            if(selectionMode) { btn.innerText = "DONE MANAGING"; btn.classList.add('bg-blue-600', 'text-white', 'border-transparent'); calDiv.classList.add('selection-mode'); showToast("Select events to manage", "info"); }
            else { btn.innerText = "MANAGE EVENTS"; btn.classList.remove('bg-blue-600', 'text-white', 'border-transparent'); calDiv.classList.remove('selection-mode'); selectedEventIds.clear(); document.querySelectorAll('.selected-event').forEach(el => el.classList.remove('selected-event')); updateBulkDeleteUI(); }
        }
        function updateBulkDeleteUI() { const fab = document.getElementById('bulkDeleteFab'); if(selectedEventIds.size > 0) { fab.classList.remove('translate-y-32'); document.getElementById('bulkDeleteCount').innerText = selectedEventIds.size; } else { fab.classList.add('translate-y-32'); } }
        window.deleteSelectedEvents = async () => { if(confirm(`Delete ${selectedEventIds.size} events?`)) { await DataService.deleteMultiple(selectedEventIds); window.toggleSelectionMode(); } }
        window.exportData = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allEvents,null,2)); const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", "GlobalHub_Backup.json"); document.body.appendChild(node); node.click(); node.remove(); }
        
        function startCountdown(events) {
            const widget = document.getElementById('countdownWidget');
            const now = new Date();
            const upcoming = events.map(e => ({...e, dateObj: new Date(e.date + 'T00:00:00')})).filter(e => e.dateObj >= now).sort((a,b) => a.dateObj - b.dateObj)[0];
            if(!upcoming) { widget.classList.add('hidden'); return; }
            widget.classList.remove('hidden');
            document.getElementById('nextEventTitle').innerText = upcoming.title;
            document.getElementById('nextEventDate').innerText = upcoming.dateObj.toLocaleDateString();
            if(countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const diff = upcoming.dateObj - new Date();
                if(diff <= 0) { clearInterval(countdownInterval); startCountdown(events); return; }
                document.getElementById('cd-d').innerText = Math.floor(diff / (1000 * 60 * 60 * 24));
                document.getElementById('cd-h').innerText = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                document.getElementById('cd-m').innerText = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            }, 1000);
        }
        window.zoomToNextEvent = () => {
             const title = document.getElementById('nextEventTitle').innerText;
             const event = calendar.getEvents().find(e => e.title === title);
             if(event) { calendar.gotoDate(event.start); showToast("Zoomed to " + title, "info"); }
        };
        function updateStats(events) {
            const counts = { game:0, movie:0, tv:0, sport:0 };
            events.forEach(e => { if(counts[e.category] !== undefined) counts[e.category]++ });
            const total = events.length;
            Object.keys(counts).forEach(cat => { document.getElementById(`count-${cat}`).innerText = counts[cat]; const pct = total === 0 ? 0 : (counts[cat] / total) * 100; document.getElementById(`bar-${cat}`).style.width = `${pct}%`; });
        }
        function updateAuthUI(user) {
            const ab = document.getElementById('authButtons'); const sa = document.getElementById('sidebarAction');
            if(user) { ab.innerHTML = `<button onclick="${isLocalMode ? 'location.reload()' : 'window.signOut(auth)'}" class="glass-button text-[9px] font-bold text-red-400 px-3 py-1.5 rounded">LOGOUT</button>`; if(sa) sa.classList.remove('opacity-50', 'pointer-events-none'); }
            else { ab.innerHTML = `<button onclick="window.openModal('loginModal')" class="glass-button text-[9px] font-bold text-white px-3 py-1.5 rounded bg-blue-600/20 border-blue-500/50">LOGIN</button>`; if(sa) sa.classList.add('opacity-50', 'pointer-events-none'); }
        }
        if(!isLocalMode) { window.signOut = signOut; onAuthStateChanged(auth, updateAuthUI); document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).then(() => window.closeModal('loginModal')).catch(e => showToast(e.message, 'error')); }); }

        function showToast(msg, type='info') {
            const t = document.createElement('div');
            const colors = type==='success'?'bg-green-500':type==='error'?'bg-red-500':'bg-blue-600';
            const icon = type==='success'?'fa-check':type==='error'?'fa-triangle-exclamation':'fa-info-circle';
            t.className = `${colors} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 text-sm font-bold animate-slide-up pointer-events-auto border border-white/10`;
            t.innerHTML = `<i class="fa-solid ${icon}"></i> ${msg}`; document.getElementById('toastContainer').appendChild(t); setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3000);
        }
    </script>
</body>
</html>
